<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Weekly Task Progress</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .task { margin-bottom: 10px; }
    .progress-bar { width: 100%; background: #ddd; height: 20px; border-radius: 10px; overflow: hidden; }
    .progress { height: 100%; background: #4caf50; width: 0%; }
    .alert { color: red; font-weight: bold; margin-left: 10px; }
  </style>
</head>
<body>
  <h2>Weekly Tasks</h2>
  <div id="tasks"></div>
  <input type="text" id="newTask" placeholder="New task name">
  <button onclick="addTask()">Add Task</button>

  <script>
    const STORAGE_KEY = "weeklyTasks";
    const WEEK_KEY = "lastResetWeek";
    const ALERT_SHOWN_KEY = "alertsShown";

    function getCurrentWeek() {
      const now = new Date();
      const start = new Date(now.getFullYear(), 0, 1);
      const week = Math.floor(((now - start) / 86400000 + start.getDay() + 1) / 7);
      return `${now.getFullYear()}-W${week}`;
    }

    function loadTasks() {
      const savedWeek = localStorage.getItem(WEEK_KEY);
      const currentWeek = getCurrentWeek();

      if (savedWeek !== currentWeek) {
        localStorage.setItem(STORAGE_KEY, JSON.stringify([]));
        localStorage.setItem(WEEK_KEY, currentWeek);
        localStorage.setItem(ALERT_SHOWN_KEY, JSON.stringify({}));
      }

      return JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
    }

    function saveTasks(tasks) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(tasks));
    }

    function saveAlertShown(taskId) {
      const alerts = JSON.parse(localStorage.getItem(ALERT_SHOWN_KEY)) || {};
      alerts[taskId] = true;
      localStorage.setItem(ALERT_SHOWN_KEY, JSON.stringify(alerts));
    }

    function hasAlertShown(taskId) {
      const alerts = JSON.parse(localStorage.getItem(ALERT_SHOWN_KEY)) || {};
      return alerts[taskId] || false;
    }

    function renderTasks() {
      const container = document.getElementById("tasks");
      container.innerHTML = "";
      const tasks = loadTasks();
      const now = new Date();

      tasks.forEach((task, index) => {
        const taskDiv = document.createElement("div");
        taskDiv.className = "task";

        const label = document.createElement("label");
        label.textContent = task.name + " ";

        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.checked = task.done;
        checkbox.onchange = () => {
          task.done = checkbox.checked;
          saveTasks(tasks);
          renderTasks();
        };

        const progressBar = document.createElement("div");
        progressBar.className = "progress-bar";
        const progress = document.createElement("div");
        progress.className = "progress";
        progress.style.width = task.done ? "100%" : "0%";
        progressBar.appendChild(progress);

        // Time left calculation
        const deadline = new Date(task.deadline);
        const diff = deadline - now;
        const hoursLeft = Math.floor(diff / 3600000);

        const alertSpan = document.createElement("span");
        alertSpan.className = "alert";

        if (!task.done && diff > 0 && hoursLeft <= 24 && !hasAlertShown(index)) {
          alertSpan.textContent = `⚠️ Due in ${hoursLeft}h`;
          saveAlertShown(index); // Mark this alert as shown (only once)
        }

        taskDiv.appendChild(checkbox);
        taskDiv.appendChild(label);
        taskDiv.appendChild(progressBar);
        taskDiv.appendChild(alertSpan);

        container.appendChild(taskDiv);
      });
    }

    function addTask() {
      const input = document.getElementById("newTask");
      const name = input.value.trim();
      if (!name) return;

      const tasks = loadTasks();
      // Default: deadline is Sunday 23:59 this week
      const now = new Date();
      const sunday = new Date(now);
      sunday.setDate(now.getDate() + (7 - now.getDay()));
      sunday.setHours(23, 59, 59, 999);

      tasks.push({ name, done: false, deadline: sunday.toISOString() });
      saveTasks(tasks);
      input.value = "";
      renderTasks();
    }

    renderTasks();
  </script>
</body>
</html>
